angular.module("angular-img-cropper",[]).directive("imageCropper",["$document","$window","imageCropperDataShare",function(t,i,e){return{scope:{image:"=",croppedImage:"=",cropWidth:"=",cropHeight:"=",keepAspect:"=",touchRadius:"=",cropAreaBounds:"=",minWidth:"=",minHeight:"=",enforceFileType:"@",jpegQuality:"=",imageStatus:"="},restrict:"A",link:function(t,i,o){var s,n=n||function(t,i){for(var e in i)i.hasOwnProperty(e)&&(t[e]=i[e]);function o(){this.constructor=t}o.prototype=i.prototype,t.prototype=new o},a=function(){function t(t,i,e){this.over=!1,this.drag=!1,this.position=new u(t,i),this.offset=new u(0,0),this.radius=e}return t.prototype.setDrag=function(t){this.drag=t,this.setOver(t)},t.prototype.draw=function(t){},t.prototype.setOver=function(t){this.over=t},t.prototype.touchInBounds=function(t,i){return t>this.position.x-this.radius&&t<this.position.x+this.radius&&i>this.position.y-this.radius&&i<this.position.y+this.radius},t.prototype.getPosition=function(){return this.position},t.prototype.setPosition=function(t,i){this.position.x=t,this.position.y=i},t}(),r=function(){function t(i){this.borrowed=0,t.instance=this;for(var e=null,o=0;o<i;o++)if(0===o)this.firstAvailable=new u,e=this.firstAvailable;else{var s=new u;e.setNext(s),e=s}}return t.prototype.borrow=function(t,i){if(null==this.firstAvailable)throw"Pool exhausted";this.borrowed++;var e=this.firstAvailable;return this.firstAvailable=e.getNext(),e.x=t,e.y=i,e},t.prototype.returnPoint=function(t){this.borrowed--,t.x=0,t.y=0,t.setNext(this.firstAvailable),this.firstAvailable=t},t}(),h=function(){function t(){}return t.init=function(t){this.canvas=t,this.ctx=this.canvas.getContext("2d")},t.DEG2RAD=.0174532925,t}(),c=function(t){function i(i,e,o){t.call(this,i,e,o),this.iconPoints=new Array,this.scaledIconPoints=new Array,this.getDragIconPoints(this.iconPoints,1),this.getDragIconPoints(this.scaledIconPoints,1.2)}return n(i,t),i.prototype.draw=function(t){this.over||this.drag?this.drawIcon(t,this.scaledIconPoints):this.drawIcon(t,this.iconPoints)},i.prototype.getDragIconPoints=function(t,i){var e=17*i,o=14*i,s=8*i,n=4*i;t.push(r.instance.borrow(-n/2,e-s)),t.push(r.instance.borrow(-o/2,e-s)),t.push(r.instance.borrow(0,e)),t.push(r.instance.borrow(o/2,e-s)),t.push(r.instance.borrow(n/2,e-s)),t.push(r.instance.borrow(n/2,n/2)),t.push(r.instance.borrow(e-s,n/2)),t.push(r.instance.borrow(e-s,o/2)),t.push(r.instance.borrow(e,0)),t.push(r.instance.borrow(e-s,-o/2)),t.push(r.instance.borrow(e-s,-n/2)),t.push(r.instance.borrow(n/2,-n/2)),t.push(r.instance.borrow(n/2,-e+s)),t.push(r.instance.borrow(o/2,-e+s)),t.push(r.instance.borrow(0,-e)),t.push(r.instance.borrow(-o/2,-e+s)),t.push(r.instance.borrow(-n/2,-e+s)),t.push(r.instance.borrow(-n/2,-n/2)),t.push(r.instance.borrow(-e+s,-n/2)),t.push(r.instance.borrow(-e+s,-o/2)),t.push(r.instance.borrow(-e,0)),t.push(r.instance.borrow(-e+s,o/2)),t.push(r.instance.borrow(-e+s,n/2)),t.push(r.instance.borrow(-n/2,n/2))},i.prototype.drawIcon=function(t,i){t.beginPath(),t.moveTo(i[0].x+this.position.x,i[0].y+this.position.y);for(var e=0;e<i.length;e++){var o=i[e];t.lineTo(o.x+this.position.x,o.y+this.position.y)}t.closePath(),t.fillStyle="rgba(255,228,0,1)",t.fill()},i.prototype.recalculatePosition=function(t){var i=t.getCentre();this.setPosition(i.x,i.y),r.instance.returnPoint(i)},i}(a),g=function(t){function i(i,e,o){t.call(this,i,e,o)}return n(i,t),i.prototype.drawCornerBorder=function(t){var i=10;(this.over||this.drag)&&(i=12);var e=1,o=1;this.horizontalNeighbour.position.x<this.position.x&&(e=-1),this.verticalNeighbour.position.y<this.position.y&&(o=-1),t.beginPath(),t.lineJoin="miter",t.moveTo(this.position.x,this.position.y),t.lineTo(this.position.x+i*e,this.position.y),t.lineTo(this.position.x+i*e,this.position.y+i*o),t.lineTo(this.position.x,this.position.y+i*o),t.lineTo(this.position.x,this.position.y),t.closePath(),t.lineWidth=2,t.strokeStyle="rgba(255,228,0,1)",t.stroke()},i.prototype.drawCornerFill=function(t){var i=10;(this.over||this.drag)&&(i=12);var e=1,o=1;this.horizontalNeighbour.position.x<this.position.x&&(e=-1),this.verticalNeighbour.position.y<this.position.y&&(o=-1),t.beginPath(),t.moveTo(this.position.x,this.position.y),t.lineTo(this.position.x+i*e,this.position.y),t.lineTo(this.position.x+i*e,this.position.y+i*o),t.lineTo(this.position.x,this.position.y+i*o),t.lineTo(this.position.x,this.position.y),t.closePath(),t.fillStyle="rgba(0,0,0,1)",t.fill()},i.prototype.moveX=function(t){this.setPosition(t,this.position.y)},i.prototype.moveY=function(t){this.setPosition(this.position.x,t)},i.prototype.move=function(t,i){this.setPosition(t,i),this.verticalNeighbour.moveX(t),this.horizontalNeighbour.moveY(i)},i.prototype.addHorizontalNeighbour=function(t){this.horizontalNeighbour=t},i.prototype.addVerticalNeighbour=function(t){this.verticalNeighbour=t},i.prototype.getHorizontalNeighbour=function(){return this.horizontalNeighbour},i.prototype.getVerticalNeighbour=function(){return this.verticalNeighbour},i.prototype.draw=function(t){this.drawCornerFill(t),this.drawCornerBorder(t)},i}(a),p=function(){function t(t,i,e,o){void 0===t&&(t=0),void 0===i&&(i=0),void 0===e&&(e=0),void 0===o&&(o=0),this.left=t,this.right=t+e,this.top=i,this.bottom=i+o}return t.prototype.getWidth=function(){return this.right-this.left},t.prototype.getHeight=function(){return this.bottom-this.top},t.prototype.getCentre=function(){var t=this.getWidth(),i=this.getHeight();return r.instance.borrow(this.left+t/2,this.top+i/2)},t}(),u=function(){function t(t,i){void 0===t&&(t=0),void 0===i&&(i=0),this.x=t,this.y=i}return t.prototype.setNext=function(t){this.next=t},t.prototype.getNext=function(){return this.next},t}(),d=function(){return function(t,i,e){void 0===t&&(t=0),void 0===i&&(i=0),void 0===e&&(e=0),this.id=0,this.x=t,this.y=i,this.id=e}}(),l=function(){function i(i,e,o,s,n,a,p){void 0===e&&(e=0),void 0===o&&(o=0),void 0===s&&(s=100),void 0===n&&(n=50),void 0===a&&(a=!0),void 0===p&&(p=20),this.keepAspect=!1,this.aspectRatio=0,this.currentDragTouches=new Array,this.isMouseDown=!1,this.ratioW=1,this.ratioH=1,this.fileType="image/png",this.imageSet=!1,this.pointPool=new r(200),h.init(i),this.buffer=document.createElement("canvas"),this.cropCanvas=document.createElement("canvas"),this.buffer.width=i.width,this.buffer.height=i.height,this.tl=new g(e,o,p),this.tr=new g(e+s,o,p),this.bl=new g(e,o+n,p),this.br=new g(e+s,o+n,p),this.tl.addHorizontalNeighbour(this.tr),this.tl.addVerticalNeighbour(this.bl),this.tr.addHorizontalNeighbour(this.tl),this.tr.addVerticalNeighbour(this.br),this.bl.addHorizontalNeighbour(this.br),this.bl.addVerticalNeighbour(this.tl),this.br.addHorizontalNeighbour(this.bl),this.br.addVerticalNeighbour(this.tr),this.markers=[this.tl,this.tr,this.bl,this.br],this.center=new c(e+s/2,o+n/2,p),this.canvas=i,this.ctx=this.canvas.getContext("2d"),this.keepAspect=a,this.aspectRatio=n/s,this.draw(this.ctx),this.croppedImage=new Image,this.currentlyInteracting=!1,this.enforceFileType=t.enforceFileType?"image/"+t.enforceFileType:void 0,this.jpegQuality=t.jpegQuality?t.jpegQuality:.8,t.imageStatus=!0,angular.element(window).off("mousemove.angular-img-cropper mouseup.angular-img-cropper touchmove.angular-img-cropper touchend.angular-img-cropper").on("mousemove.angular-img-cropper",this.onMouseMove.bind(this)).on("mouseup.angular-img-cropper",this.onMouseUp.bind(this)).on("touchmove.angular-img-cropper",this.onTouchMove.bind(this)).on("touchend.angular-img-cropper",this.onTouchEnd.bind(this)),angular.element(i).off("mousedown.angular-img-cropper touchstart.angular-img-cropper").on("mousedown.angular-img-cropper",this.onMouseDown.bind(this)).on("touchstart.angular-img-cropper",this.onTouchStart.bind(this))}return i.prototype.resizeCanvas=function(t,i){this.canvas.width=t,this.canvas.height=i,this.buffer.width=t,this.buffer.height=i,this.draw(this.ctx)},i.prototype.draw=function(i){var e=this.getBounds();if(this.srcImage&&this.srcImage.height>=t.cropHeight&&this.srcImage.width>=t.cropWidth){i.clearRect(0,0,this.canvasWidth,this.canvasHeight);var o=this.srcImage.height/this.srcImage.width,s=this.canvasHeight/this.canvasWidth,n=this.canvasWidth,a=this.canvasHeight;s>o?(n=this.canvasWidth,a=this.canvasWidth*o):(a=this.canvasHeight,n=this.canvasHeight/o),this.ratioW=n/this.srcImage.width,this.ratioH=a/this.srcImage.height,s<o?this.drawImageIOSFix(i,this.srcImage,0,0,this.srcImage.width,this.srcImage.height,this.buffer.width/2-n/2,0,n,a):this.drawImageIOSFix(i,this.srcImage,0,0,this.srcImage.width,this.srcImage.height,0,this.buffer.height/2-a/2,n,a),this.buffer.getContext("2d").drawImage(this.canvas,0,0,this.canvasWidth,this.canvasHeight),i.fillStyle="rgba(0, 0, 0, 0.7)",i.fillRect(0,0,this.canvasWidth,this.canvasHeight),i.drawImage(this.buffer,e.left,e.top,Math.max(e.getWidth(),1),Math.max(e.getHeight(),1),e.left,e.top,e.getWidth(),e.getHeight());for(var r=i.getImageData(e.left,e.top,e.getWidth(),e.getHeight()),h=r.data,c=0;c<h.length;c+=4)h[c+3]<255&&(h[c]=255,h[c+1]=255,h[c+2]=255,h[c+3]=255);i.putImageData(r,e.left,e.top);for(c=0;c<this.markers.length;c++)this.markers[c].draw(i);this.center.draw(i),i.lineWidth=2,i.strokeStyle="rgba(255,228,0,1)",i.strokeRect(e.left,e.top,e.getWidth(),e.getHeight())}else this.srcImage&&(this.srcImage.height<t.cropHeight||this.srcImage.width<t.cropWidth)?(i.fillStyle="#000",i.font="30px Georgia",i.textAlign="center",i.fillText("Image is too small",this.canvas.width/2,this.canvas.height/2),t.imageStatus=!1):(i.fillStyle="#000",i.font="30px Georgia",i.textAlign="center",i.fillText("Invalid image source",this.canvas.width/2,this.canvas.height/2),t.imageStatus=!1)},i.prototype.dragCrop=function(i,e,o){var s=this.getBounds(),n=i-s.getWidth()/2,a=i+s.getWidth()/2,r=e-s.getHeight()/2,h=e+s.getHeight()/2;a>=this.maxXClamp&&(i=this.maxXClamp-s.getWidth()/2),n<=this.minXClamp&&(i=s.getWidth()/2+this.minXClamp),r<this.minYClamp&&(e=s.getHeight()/2+this.minYClamp),h>=this.maxYClamp&&(e=this.maxYClamp-s.getHeight()/2),this.tl.moveX(i-s.getWidth()/2),this.tl.moveY(e-s.getHeight()/2),this.tr.moveX(i+s.getWidth()/2),this.tr.moveY(e-s.getHeight()/2),this.bl.moveX(i-s.getWidth()/2),this.bl.moveY(e+s.getHeight()/2),this.br.moveX(i+s.getWidth()/2),this.br.moveY(e+s.getHeight()/2),o.setPosition(i,e),t.cropAreaBounds&&this.imageSet&&(t.cropAreaBounds=this.getCropBounds(),t.$apply())},i.prototype.enforceMinSize=function(i,e,o){var s=i-o.getHorizontalNeighbour().getPosition().x,n=e-o.getVerticalNeighbour().getPosition().y,a=t.minWidth-Math.abs(s),h=t.minHeight-Math.abs(n);return 0==s||0==n?(i=o.getPosition().x,e=o.getPosition().y,r.instance.borrow(i,e)):(t.keepAspect?a>0&&h/this.aspectRatio>0?a>h/this.aspectRatio?s<0?(i-=a,n<0?e-=a*this.aspectRatio:e+=a*this.aspectRatio):(i+=a,n<0?e-=a*this.aspectRatio:e+=a*this.aspectRatio):n<0?(e-=h,s<0?i-=h/this.aspectRatio:i+=h/this.aspectRatio):(e+=h,s<0?i-=h/this.aspectRatio:i+=h/this.aspectRatio):a>0?s<0?(i-=a,n<0?e-=a*this.aspectRatio:e+=a*this.aspectRatio):(i+=a,n<0?e-=a*this.aspectRatio:e+=a*this.aspectRatio):h>0&&(n<0?(e-=h,s<0?i-=h/this.aspectRatio:i+=h/this.aspectRatio):(e+=h,s<0?i-=h/this.aspectRatio:i+=h/this.aspectRatio)):(a>0&&(s<0?i-=a:i+=a),h>0&&(n<0?e-=h:e+=h)),(i<this.minXClamp||i>this.maxXClamp||e<this.minYClamp||e>this.maxYClamp)&&(i=o.getPosition().x,e=o.getPosition().y),r.instance.borrow(i,e))},i.prototype.dragCorner=function(i,e,o){var s,n=0,a=0,h=0,c=0,g=0,p=0,u=0,d=0,l=0;if(t.keepAspect){if(h=(s=o.getHorizontalNeighbour().getVerticalNeighbour()).getPosition().x,c=s.getPosition().y,i<=s.getPosition().x){if(e<=s.getPosition().y){if(n=h-100/this.aspectRatio,a=c-100/this.aspectRatio*this.aspectRatio,(l=this.getSide(r.instance.borrow(n,a),s.getPosition(),r.instance.borrow(i,e)))>0){p=(g=Math.abs(s.getPosition().y-e))/this.aspectRatio,u=s.getPosition().y-g,d=s.getPosition().x-p;var m=this.enforceMinSize(d,u,o);o.move(m.x,m.y),r.instance.returnPoint(m)}else if(l<0){g=(p=Math.abs(s.getPosition().x-i))*this.aspectRatio,u=s.getPosition().y-g,d=s.getPosition().x-p;m=this.enforceMinSize(d,u,o);o.move(m.x,m.y),r.instance.returnPoint(m)}}else if(n=h-100/this.aspectRatio,a=c+100/this.aspectRatio*this.aspectRatio,(l=this.getSide(r.instance.borrow(n,a),s.getPosition(),r.instance.borrow(i,e)))>0){g=(p=Math.abs(s.getPosition().x-i))*this.aspectRatio,u=s.getPosition().y+g,d=s.getPosition().x-p;m=this.enforceMinSize(d,u,o);o.move(m.x,m.y),r.instance.returnPoint(m)}else if(l<0){p=(g=Math.abs(s.getPosition().y-e))/this.aspectRatio,u=s.getPosition().y+g,d=s.getPosition().x-p;m=this.enforceMinSize(d,u,o);o.move(m.x,m.y),r.instance.returnPoint(m)}}else if(e<=s.getPosition().y){if(n=h+100/this.aspectRatio,a=c-100/this.aspectRatio*this.aspectRatio,(l=this.getSide(r.instance.borrow(n,a),s.getPosition(),r.instance.borrow(i,e)))<0){p=(g=Math.abs(s.getPosition().y-e))/this.aspectRatio,u=s.getPosition().y-g,d=s.getPosition().x+p;m=this.enforceMinSize(d,u,o);o.move(m.x,m.y),r.instance.returnPoint(m)}else if(l>0){g=(p=Math.abs(s.getPosition().x-i))*this.aspectRatio,u=s.getPosition().y-g,d=s.getPosition().x+p;m=this.enforceMinSize(d,u,o);o.move(m.x,m.y),r.instance.returnPoint(m)}}else if(n=h+100/this.aspectRatio,a=c+100/this.aspectRatio*this.aspectRatio,(l=this.getSide(r.instance.borrow(n,a),s.getPosition(),r.instance.borrow(i,e)))<0){g=(p=Math.abs(s.getPosition().x-i))*this.aspectRatio,u=s.getPosition().y+g,d=s.getPosition().x+p;m=this.enforceMinSize(d,u,o);o.move(m.x,m.y),r.instance.returnPoint(m)}else if(l>0){p=(g=Math.abs(s.getPosition().y-e))/this.aspectRatio,u=s.getPosition().y+g,d=s.getPosition().x+p;m=this.enforceMinSize(d,u,o);o.move(m.x,m.y),r.instance.returnPoint(m)}}else{m=this.enforceMinSize(i,e,o);o.move(m.x,m.y),r.instance.returnPoint(m)}this.center.recalculatePosition(this.getBounds()),t.cropAreaBounds&&this.imageSet&&(t.cropAreaBounds=this.getCropBounds(),t.$apply())},i.prototype.getSide=function(t,i,e){var o=this.sign((i.x-t.x)*(e.y-t.y)-(i.y-t.y)*(e.x-t.x));return r.instance.returnPoint(t),r.instance.returnPoint(e),o},i.prototype.sign=function(t){return+t===t?0===t?t:t>0?1:-1:NaN},i.prototype.handleRelease=function(t){if(null!=t){for(var i=0,e=0;e<this.currentDragTouches.length;e++)t.id==this.currentDragTouches[e].id&&(this.currentDragTouches[e].dragHandle.setDrag(!1),t.dragHandle=null,i=e);this.currentDragTouches.splice(i,1),this.draw(this.ctx)}},i.prototype.handleMove=function(t){for(var i=!1,o=0;o<this.currentDragTouches.length;o++)if(t.id==this.currentDragTouches[o].id&&null!=this.currentDragTouches[o].dragHandle){var s=this.currentDragTouches[o],n=this.clampPosition(t.x-s.dragHandle.offset.x,t.y-s.dragHandle.offset.y);t.x=n.x,t.y=n.y,r.instance.returnPoint(n),s.dragHandle instanceof g?this.dragCorner(t.x,t.y,s.dragHandle):this.dragCrop(t.x,t.y,s.dragHandle),this.currentlyInteracting=!0,i=!0,e.setPressed(this.canvas);break}if(!i){for(var a=0;a<this.markers.length;a++){var h=this.markers[a];if(h.touchInBounds(t.x,t.y)){t.dragHandle=h,this.currentDragTouches.push(t),h.setDrag(!0),t.dragHandle.offset.x=t.x-t.dragHandle.getPosition().x,t.dragHandle.offset.y=t.y-t.dragHandle.getPosition().y,this.dragCorner(t.x-t.dragHandle.offset.x,t.y-t.dragHandle.offset.y,t.dragHandle);break}}null==t.dragHandle&&this.center.touchInBounds(t.x,t.y)&&(t.dragHandle=this.center,this.currentDragTouches.push(t),t.dragHandle.setDrag(!0),t.dragHandle.offset.x=t.x-t.dragHandle.getPosition().x,t.dragHandle.offset.y=t.y-t.dragHandle.getPosition().y,this.dragCrop(t.x-t.dragHandle.offset.x,t.y-t.dragHandle.offset.y,t.dragHandle))}},i.prototype.updateClampBounds=function(){var t=this.srcImage.height/this.srcImage.width,i=this.canvas.height/this.canvas.width,e=this.canvas.width,o=this.canvas.height;i>t?(e=this.canvas.width,o=this.canvas.width*t):(o=this.canvas.height,e=this.canvas.height/t),this.minXClamp=this.canvas.width/2-e/2,this.minYClamp=this.canvas.height/2-o/2,this.maxXClamp=this.canvas.width/2+e/2,this.maxYClamp=this.canvas.height/2+o/2},i.prototype.getCropBounds=function(){var t=this.canvas.height-2*this.minYClamp,i=this.getBounds();return i.top=Math.round((t-i.top+this.minYClamp)/this.ratioH),i.bottom=Math.round((t-i.bottom+this.minYClamp)/this.ratioH),i.left=Math.round((i.left-this.minXClamp)/this.ratioW),i.right=Math.round((i.right-this.minXClamp)/this.ratioW),i},i.prototype.clampPosition=function(t,i){return t<this.minXClamp&&(t=this.minXClamp),t>this.maxXClamp&&(t=this.maxXClamp),i<this.minYClamp&&(i=this.minYClamp),i>this.maxYClamp&&(i=this.maxYClamp),r.instance.borrow(t,i)},i.prototype.isImageSet=function(){return this.imageSet},i.prototype.setImage=function(i,e){if(!i)throw"Image is null";this.imageSet=!0,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.buffer.getContext("2d").clearRect(0,0,this.buffer.width,this.buffer.height),this.enforceFileType?this.fileType=this.enforceFileType:"image/png"!=e&&"image/jpeg"!=e||(this.fileType=e),this.srcImage=i,this.updateClampBounds();var s=this.srcImage.height/this.srcImage.width,n=this.getBounds(),a=n.getHeight()/n.getWidth(),h=this.canvas.width,c=this.canvas.height;this.canvasWidth=h,this.canvasHeight=c;var g=this.canvas.width/2,u=this.canvas.height/2,d=r.instance.borrow(g-n.getWidth()/2,u+n.getHeight()/2),l=r.instance.borrow(g+n.getWidth()/2,u+n.getHeight()/2),m=r.instance.borrow(g-n.getWidth()/2,u-n.getHeight()/2),f=r.instance.borrow(g+n.getWidth()/2,u-n.getHeight()/2);if(this.tl.setPosition(d.x,d.y),this.tr.setPosition(l.x,l.y),this.bl.setPosition(m.x,m.y),this.br.setPosition(f.x,f.y),r.instance.returnPoint(d),r.instance.returnPoint(l),r.instance.returnPoint(m),r.instance.returnPoint(f),this.center.setPosition(g,u),a>s){var v=Math.min(h*s,c),y=v/a;d=r.instance.borrow(g-y/2,u+v/2),l=r.instance.borrow(g+y/2,u+v/2),m=r.instance.borrow(g-y/2,u-v/2),f=r.instance.borrow(g+y/2,u-v/2)}else if(a<s){var w=(b=Math.min(c/s,h))*a;d=r.instance.borrow(g-b/2,u+w/2),l=r.instance.borrow(g+b/2,u+w/2),m=r.instance.borrow(g-b/2,u-w/2),f=r.instance.borrow(g+b/2,u-w/2)}else{var b;w=(b=Math.min(c,h))*a;d=r.instance.borrow(g-b/2,u+w/2),l=r.instance.borrow(g+b/2,u+w/2),m=r.instance.borrow(g-b/2,u-w/2),f=r.instance.borrow(g+b/2,u-w/2)}if(this.tl.setPosition(d.x,d.y),this.tr.setPosition(l.x,l.y),this.bl.setPosition(m.x,m.y),this.br.setPosition(f.x,f.y),r.instance.returnPoint(d),r.instance.returnPoint(l),r.instance.returnPoint(m),r.instance.returnPoint(f),t.cropAreaBounds&&void 0!==t.cropAreaBounds.left&&void 0!==t.cropAreaBounds.top&&void 0!==t.cropAreaBounds.right&&void 0!==t.cropAreaBounds.bottom){this.canvasHeight/this.canvasWidth>s?(h=this.canvasWidth,c=this.canvasWidth*s):(c=this.canvasHeight,h=this.canvasHeight/s),this.ratioW=h/this.srcImage.width,this.ratioH=c/this.srcImage.height;var x=new p;x.top=Math.round(c+this.minYClamp-this.ratioH*t.cropAreaBounds.top),x.bottom=Math.round(c+this.minYClamp-this.ratioH*t.cropAreaBounds.bottom),x.left=Math.round(this.ratioW*t.cropAreaBounds.left+this.minXClamp),x.right=Math.round(this.ratioW*t.cropAreaBounds.right+this.minXClamp),this.tl.setPosition(x.left,x.top),this.tr.setPosition(x.right,x.top),this.bl.setPosition(x.left,x.bottom),this.br.setPosition(x.right,x.bottom),this.center.setPosition(x.left+x.getWidth()/2,x.top+x.getHeight()/2)}this.vertSquashRatio=this.detectVerticalSquash(this.srcImage),this.draw(this.ctx);var P=this.getCroppedImage(t.cropWidth,t.cropHeight);void 0!==o.croppedImage&&(t.croppedImage=P.src),t.cropAreaBounds&&this.imageSet&&(t.cropAreaBounds=this.getCropBounds())},i.prototype.getCroppedImage=function(t,i){var e=this.getBounds();if(!this.srcImage)throw"Source image not set.";var o=this.cropCanvas.getContext("2d");if(t&&i){var s=this.srcImage.height/this.srcImage.width,n=this.canvas.height/this.canvas.width,a=this.canvas.width,r=this.canvas.height;n>s?(a=this.canvas.width,r=this.canvas.width*s):n<s?(r=this.canvas.height,a=this.canvas.height/s):(r=this.canvas.height,a=this.canvas.width),this.ratioW=a/this.srcImage.width,this.ratioH=r/this.srcImage.height,this.cropCanvas.width=t,this.cropCanvas.height=i;var h=(this.buffer.height-r)/2/this.ratioH,c=(this.buffer.width-a)/2/this.ratioW;this.drawImageIOSFix(o,this.srcImage,Math.max(Math.round(e.left/this.ratioW-c),0),Math.max(Math.round(e.top/this.ratioH-h),0),Math.max(Math.round(e.getWidth()/this.ratioW),1),Math.max(Math.round(e.getHeight()/this.ratioH),1),0,0,t,i);for(var g=(u=o.getImageData(0,0,t,i)).data,p=0;p<g.length;p+=4)g[p+3]<255&&(g[p]=255,g[p+1]=255,g[p+2]=255,g[p+3]=255);this.croppedImage.width=t,this.croppedImage.height=i}else{this.cropCanvas.width=Math.max(e.getWidth(),1),this.cropCanvas.height=Math.max(e.getHeight(),1),o.drawImage(this.buffer,e.left,e.top,Math.max(e.getWidth(),1),Math.max(e.getHeight(),1),0,0,e.getWidth(),e.getHeight());var u;for(g=(u=o.getImageData(0,0,e.getWidth(),e.getHeight())).data,p=0;p<g.length;p+=4)g[p+3]<255&&(g[p]=255,g[p+1]=255,g[p+2]=255,g[p+3]=255);this.croppedImage.width=this.cropCanvas.width,this.croppedImage.height=this.cropCanvas.height}return o.putImageData(u,0,0),"image/jpeg"==this.fileType||"image/jpg"==this.fileType?this.croppedImage.src=this.cropCanvas.toDataURL(this.fileType,this.jpegQuality):this.croppedImage.src=this.cropCanvas.toDataURL(this.fileType),this.croppedImage},i.prototype.getBounds=function(){for(var t=Number.MAX_VALUE,i=Number.MAX_VALUE,e=-Number.MAX_VALUE,o=-Number.MAX_VALUE,s=0;s<this.markers.length;s++){var n=this.markers[s];n.getPosition().x<t&&(t=n.getPosition().x),n.getPosition().x>e&&(e=n.getPosition().x),n.getPosition().y<i&&(i=n.getPosition().y),n.getPosition().y>o&&(o=n.getPosition().y)}var a=new p;return a.left=t,a.right=e,a.top=i,a.bottom=o,a},i.prototype.setBounds=function(t){for(var i,e,o,s,n=this.getBounds(),a=0;a<this.markers.length;a++){var r=this.markers[a];r.getPosition().x==n.left?r.getPosition().y==n.top?i=r:o=r:r.getPosition().y==n.top?e=r:s=r}i.setPosition(t.left,t.top),e.setPosition(t.right,t.top),o.setPosition(t.left,t.bottom),s.setPosition(t.right,t.bottom),this.center.recalculatePosition(t),this.center.draw(this.ctx)},i.prototype.getMousePos=function(t,i){var e=t.getBoundingClientRect();return r.instance.borrow(i.clientX-e.left,i.clientY-e.top)},i.prototype.getTouchPos=function(t,i){var e=t.getBoundingClientRect();return r.instance.borrow(i.clientX-e.left,i.clientY-e.top)},i.prototype.onTouchMove=function(t){if(s.isImageSet()){if(t.preventDefault(),t.touches.length>=1)for(var i=0;i<t.touches.length;i++){var e=t.touches[i],o=this.getTouchPos(this.canvas,e),n=new d(o.x,o.y,e.identifier);r.instance.returnPoint(o),this.move(n,t)}this.draw(this.ctx)}},i.prototype.onMouseMove=function(t){if(s.isImageSet()){var i=this.getMousePos(this.canvas,t);this.move(new d(i.x,i.y,0),t);var e=this.getDragTouchForID(0);e?(e.x=i.x,e.y=i.y):e=new d(i.x,i.y,0),r.instance.returnPoint(i),this.drawCursors(e,t),this.draw(this.ctx)}},i.prototype.move=function(t,i){this.isMouseDown&&this.handleMove(t)},i.prototype.getDragTouchForID=function(t){for(var i=0;i<this.currentDragTouches.length;i++)if(t==this.currentDragTouches[i].id)return this.currentDragTouches[i]},i.prototype.drawCursors=function(t,i){var o=!1;null!=t&&(t.dragHandle==this.center&&(e.setStyle(this.canvas,"move"),o=!0),null!=t.dragHandle&&t.dragHandle instanceof g&&(this.drawCornerCursor(t.dragHandle,t.dragHandle.getPosition().x,t.dragHandle.getPosition().y,i),o=!0));var s=!1;if(!o){for(var n=0;n<this.markers.length;n++)s=s||this.drawCornerCursor(this.markers[n],t.x,t.y,i);s||e.setStyle(this.canvas,"initial")}s||o||!this.center.touchInBounds(t.x,t.y)?this.center.setOver(!1):(this.center.setOver(!0),e.setOver(this.canvas),e.setStyle(this.canvas,"move"))},i.prototype.drawCornerCursor=function(t,i,o,s){return t.touchInBounds(i,o)?(t.setOver(!0),t.getHorizontalNeighbour().getPosition().x>t.getPosition().x?t.getVerticalNeighbour().getPosition().y>t.getPosition().y?(e.setOver(this.canvas),e.setStyle(this.canvas,"nwse-resize")):(e.setOver(this.canvas),e.setStyle(this.canvas,"nesw-resize")):t.getVerticalNeighbour().getPosition().y>t.getPosition().y?(e.setOver(this.canvas),e.setStyle(this.canvas,"nesw-resize")):(e.setOver(this.canvas),e.setStyle(this.canvas,"nwse-resize")),!0):(t.setOver(!1),!1)},i.prototype.onTouchStart=function(t){s.isImageSet()&&(this.isMouseDown=!0)},i.prototype.onTouchEnd=function(i){if(s.isImageSet()){for(var e=0;e<i.changedTouches.length;e++){var n=i.changedTouches[e],a=this.getDragTouchForID(n.identifier);null!=a&&((a.dragHandle instanceof g||a.dragHandle instanceof c)&&a.dragHandle.setOver(!1),this.handleRelease(a))}if(s.isImageSet()&&this.currentlyInteracting){var r=this.getCroppedImage(t.cropWidth,t.cropHeight);void 0!==o.croppedImage&&(t.croppedImage=r.src),t.$apply()}0==this.currentDragTouches.length&&(this.isMouseDown=!1,this.currentlyInteracting=!1)}},i.prototype.drawImageIOSFix=function(t,i,e,o,s,n,a,r,h,c){t.drawImage(i,e*this.vertSquashRatio,o*this.vertSquashRatio,s*this.vertSquashRatio,n*this.vertSquashRatio,a,r,h,c)},i.prototype.detectVerticalSquash=function(t){t.naturalWidth;var i=t.naturalHeight,e=document.createElement("canvas");e.width=1,e.height=i;var o=e.getContext("2d");o.drawImage(t,0,0);for(var s=o.getImageData(0,0,1,i).data,n=0,a=i,r=i;r>n;){0===s[4*(r-1)+3]?a=r:n=r,r=a+n>>1}var h=r/i;return 0===h?1:h},i.prototype.onMouseDown=function(t){s.isImageSet()&&(this.isMouseDown=!0)},i.prototype.onMouseUp=function(i){if(s.isImageSet()){if(e.setReleased(this.canvas),this.isMouseDown=!1,this.handleRelease(new d(0,0,0)),1==this.currentlyInteracting){var n=this.getCroppedImage(t.cropWidth,t.cropHeight);void 0!==o.croppedImage&&(t.croppedImage=n.src),t.$apply()}this.currentlyInteracting=!1}},i}();function m(e,o){if(!s||e!==o){var n=i[0],a=t.cropWidth,r=t.cropHeight,h=t.keepAspect,c=t.touchRadius,g=s&&s.srcImage;s=new l(n,n.width/2-a/2,n.height/2-r/2,a,r,h,c),$(n).data("crop.angular-img-cropper",s),g?s.setImage(g,t.image.fileType):f(t.image)}}function f(i){if(i){var e=new Image;void 0!==o.cors&&"no"!==o.cors&&(e.crossOrigin="Anonymous"),e.addEventListener("load",function(){s.setImage(e,i.fileType),t.$apply()},!1),e.src=i.imageData}}t.$watch("cropWidth",m),t.$watch("cropHeight",m),t.$watch("keepAspect",m),t.$watch("touchRadius",m),t.$watch("image",f)}}}]),angular.module("angular-img-cropper").directive("imgCropperFileread",["$timeout",function(t){return{scope:{image:"="},link:function(i,e){e.bind("change",function(e){var o=new FileReader,s=this;o.onload=function(e){t(function(){var t=s;i.image={imageData:e.target.result,fileType:t.fileType}},0)},e.target.files[0]&&(s.fileType=e.target.files[0].type,o.readAsDataURL(e.target.files[0]))})}}}]),angular.module("angular-img-cropper").directive("imgCropperFilereadCall",function(){return{scope:{control:"="},link:function(t){t.internalControl=t.control||{},t.internalControl.load=function(t){var i=angular.element(document.querySelector(t)),e=document.createEvent("MouseEvent");e.initEvent("click",!0,!1),i[0].dispatchEvent(e)}}}}),angular.module("angular-img-cropper").factory("imageCropperDataShare",function(){var t,i,e={};return e.setPressed=function(i){t=i},e.setReleased=function(i){i===t&&(t=void 0)},e.setOver=function(t){i=t},e.setStyle=function(e,o){void 0!==t?t===e&&angular.element(document.documentElement).css("cursor",o):e===i&&angular.element(document.documentElement).css("cursor",o)},e});